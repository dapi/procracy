# Use Case: Идентификация граждан (Ed25519)

> Связанный закон: [005-identity](../../laws/005-identity.md)

---

## UC-1. Генерация ключа при подаче гражданства

**Актор**: Новый игрок
**Предусловие**: Игрок имеет GitHub-аккаунт

**Основной сценарий**:
1. Игрок генерирует пару ключей Ed25519 (см. примеры в Законе 005, раздел 7)
2. Игрок копирует шаблон `citizenship/template/APPLICATION.md`
3. Игрок заполняет данные, включая публичный ключ (base64) в поле `public_key`
4. Игрок подаёт PR с заголовком `citizenship: <username>`
5. PR проходит ревью и cooling period
6. Гражданство принято — ключ зарегистрирован в системе

**Альтернативный сценарий**:
- 3a. Публичный ключ не указан → PR не принимается (п. 2.2 Закона 005)
- 3b. Публичный ключ уже занят другим гражданином → PR не принимается (п. 2.3)

---

## UC-2. Подпись запроса к API

**Актор**: Гражданин (через AI-агента или напрямую)
**Предусловие**: Гражданство принято, ключ зарегистрирован

**Основной сценарий**:
1. Агент формирует HTTP-запрос (например, `POST /api/mine`)
2. Агент вычисляет SHA-256 хеш тела запроса
3. Агент формирует сообщение: `POST\n/api/mine\n2026-02-28T12:00:00Z\n<body_hash>`
4. Агент подписывает сообщение приватным ключом Ed25519
5. Агент добавляет заголовки: `X-Citizen`, `X-Timestamp`, `X-Signature`
6. Сервер верифицирует подпись и выполняет запрос

**Альтернативные сценарии**:
- 4a. Подпись невалидна → сервер возвращает `401 Invalid signature`
- 5a. Timestamp за пределами ±5 минут → `401 Timestamp expired`
- 5b. Nonce уже использован → `401 Nonce reused`

---

## UC-3. Ротация ключа

**Актор**: Гражданин
**Предусловие**: Гражданство активно

**Основной сценарий**:
1. Гражданин генерирует новую пару ключей Ed25519
2. Гражданин подаёт PR, обновляющий `public_key` в своём файле гражданства
3. PR проходит ревью (уровень "Код")
4. После merge старый ключ перестаёт действовать, новый активен

**Примечание**: В период между подачей PR и его принятием действует старый ключ.

---

## UC-4. Реакция на компрометацию ключа

**Актор**: Гражданин (жертва)
**Предусловие**: Приватный ключ скомпрометирован или подозревается в утечке

**Основной сценарий**:
1. Гражданин создаёт Issue с меткой `key-compromised`
2. Гражданин генерирует новую пару ключей
3. Гражданин подаёт PR с новым публичным ключом
4. Администраторы экстренно блокируют старый ключ (до merge PR)
5. PR принимается — новый ключ активен

**Альтернативный сценарий**:
- 1a. Гражданин не имеет доступа к GitHub → обращается к администраторам через другой канал
- 4a. Злоумышленник совершает действия до блокировки → действия могут быть оспорены (п. 6.3 Закона 005)
